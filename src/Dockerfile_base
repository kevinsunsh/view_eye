FROM python:3.12-slim

# 设置工作目录
WORKDIR /opt/application

# 设置用户
USER root

# 复制依赖文件
COPY requirements.txt .

# 安装系统依赖（git 用于安装 requirements 里的 git 源依赖）
# 同时安装 OpenCV 运行时所需库，避免 libGL.so.1 缺失
RUN apt-get update \
    && apt-get install -y --no-install-recommends \
        git \
        libglib2.0-0 \
        libsm6 \
        libxext6 \
        libxrender1 \
        libgl1 \
    && rm -rf /var/lib/apt/lists/*

# 配置 pip 使用清华镜像源
RUN pip config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple \
    && pip config set global.trusted-host pypi.tuna.tsinghua.edu.cn \
    && pip config set global.timeout 300

# 升级 pip
RUN pip install --upgrade pip

# 安装依赖
# 先安装 PyTorch CPU 版本
RUN pip install --no-cache-dir torch==2.8.0+cpu torchvision==0.23.0+cpu --index-url https://download.pytorch.org/whl/cpu
# 然后安装其他依赖
RUN pip install --no-cache-dir -r requirements.txt
